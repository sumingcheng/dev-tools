user nginx;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 定义上游代理服务器
    upstream proxy_server {
        server 127.0.0.1:7890;
    }

    # 哔哩哔哩相关域名映射
    map $http_host $proxy_host {
        ~^.*\.bilibili\.com$ $http_host;
        ~^.*\.bilivideo\.com$ $http_host;
        ~^.*\.biliapi\.net$ $http_host;
        ~^.*\.hdslb\.com$ $http_host;
        default $http_host;
    }

    server {
        listen 6666;
        resolver 8.8.8.8;  # DNS 解析器

        # 哔哩哔哩网站代理
        location / {
            if ($proxy_host ~* (bilibili|bilivideo|biliapi|hdslb)) {
                proxy_pass http://proxy_server;
            }

            proxy_http_version 1.1;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # 增加超时时间
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            # 处理大文件
            client_max_body_size 20m;
        }
    }
}